<?xml version="1.0" encoding="ISO-8859-1"?>
<package xmlns="http://www.lovullo.com/rater"
  xmlns:c="http://www.lovullo.com/calc"
  core="true"
  desc="Date and time">

  <import package="base" />


  <!--
    Determines how many years the given date is relative to the current date

    Note that a positive number will be returned if the given date is in the past,
    negative if in the future.
  -->
  <template name="_ageYears_" desc="Age in years of the given date relative to the current">
    <param name="@generates@" desc="Generator variable, per index" />
    <param name="@yearset@"   desc="Set of years to iterate on" />
    <param name="@sym@"       desc="Generator symbol" />
    <param name="@when@"      desc="Only when this boolean value is true" />
    <param name="@default@"   desc="Default age when yearset values are empty" />

    <param name="@yields@" desc="Variable to yield into">
      <text>_</text>
      <param-value name="@generates@" />
    </param>


    <rate yields="@yields@">
      <c:sum of="@yearset@" index="k" generates="@generates@" desc="Relative age" sym="@sym@">
        <c:cases>
          <if name="@when@">
            <c:case>
              <c:when name="@when@" index="k">
                <c:eq>
                  <c:value-of name="FALSE" />
                </c:eq>
              </c:when>

              <!-- return a default, or 0 if no default is provided -->
              <if name="@default@">
                <c:value-of name="@default@" index="k" />
              </if>
              <unless name="@default@">
                <c:const value="0" type="integer" desc="Condition not met, but no default" />
              </unless>
            </c:case>
          </if>

          <!-- if no @when@, then we'll always do this -->
          <c:otherwise>
            <c:cases>
              <c:case>
                <c:when name="@yearset@" index="k">
                  <c:gt>
                    <c:const value="0" type="integer" desc="Only calculate difference if a value is available" />
                  </c:gt>
                </c:when>

                <c:sum label="Calculate by subtracting the given year from the current year">
                  <c:value-of name="__DATE_YEAR__" />

                  <c:product>
                    <c:value-of name="NEGATE" />
                    <c:value-of name="@yearset@" index="k" />
                  </c:product>
                </c:sum>
              </c:case>

              <!-- we don't have a value; just use the default age we were given -->
              <if name="@default@">
                <c:otherwise>
                  <c:value-of name="@default@" index="k" />
                </c:otherwise>
              </if>
            </c:cases>
          </c:otherwise>
        </c:cases>
      </c:sum>
    </rate>
  </template>
</package>

