<?xml-stylesheet type="text/xsl" href="summary.xsl"?>
<lv:package
  xmlns:lv="http://www.lovullo.com/rater"
  xmlns:c="http://www.lovullo.com/calc"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.lovullo.com/rater ../rater.xsd"

  core="true"

  name="core/datetime"
  desc="Date and time">

  <lv:import package="base" />


  <!--
    Determines how many years the given date is relative to the current date

    Note that a positive number will be returned if the given date is in the past,
    negative if in the future.
  -->
  <lv:template name="_ageYears_" desc="Age in years of the given date relative to the current">
    <lv:param name="@generates@" desc="Generator variable, per index" />
    <lv:param name="@yearset@"   desc="Set of years to iterate on" />
    <lv:param name="@sym@"       desc="Generator symbol" />
    <lv:param name="@when@"      desc="Only when this boolean value is true" />
    <lv:param name="@default@"   desc="Default age when yearset values are empty" />

    <lv:param name="@yields@" desc="Variable to yield into">
      <lv:text>_</lv:text>
      <lv:param-value name="@generates@" />
    </lv:param>


    <lv:rate yields="@yields@">
      <c:sum of="@yearset@" index="k" generates="@generates@" desc="Relative age" sym="@sym@">
        <c:cases>
          <lv:if name="@when@">
            <c:case>
              <c:when name="@when@" index="k">
                <c:eq>
                  <c:value-of name="FALSE" />
                </c:eq>
              </c:when>

              <!-- return a default, or 0 if no default is provided -->
              <lv:if name="@default@">
                <c:value-of name="@default@" index="k" />
              </lv:if>
              <lv:unless name="@default@">
                <c:const value="0" type="integer" desc="Condition not met, but no default" />
              </lv:unless>
            </c:case>
          </lv:if>

          <!-- if no @when@, then we'll always do this -->
          <c:otherwise>
            <c:cases>
              <c:case>
                <c:when name="@yearset@" index="k">
                  <c:gt>
                    <c:const value="0" type="integer" desc="Only calculate difference if a value is available" />
                  </c:gt>
                </c:when>

                <c:sum label="Calculate by subtracting the given year from the current year">
                  <c:value-of name="__DATE_YEAR__" />

                  <c:product>
                    <c:value-of name="NEGATE" />
                    <c:value-of name="@yearset@" index="k" />
                  </c:product>
                </c:sum>
              </c:case>

              <!-- we don't have a value; just use the default age we were given -->
              <lv:if name="@default@">
                <c:otherwise>
                  <c:value-of name="@default@" index="k" />
                </c:otherwise>
              </lv:if>
            </c:cases>
          </c:otherwise>
        </c:cases>
      </c:sum>
    </lv:rate>
  </lv:template>
</lv:package>
