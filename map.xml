<?xml version="1.0" encoding="ISO-8859-1"?>
<!--
  Copyright (C) 2015  LoVullo Associates, Inc.

  This file is part of tame-core.

  tame-core is free software: you can redistribute it and/or modify it
  under the terms of the GNU Lesser General Public License as
  published by the Free Software Foundation, either version 3 of the
  License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

<!--
  Brings c:case statements to life

  The problem with cases is that they are so verbose for simple cases. This
  makes simple cases simple.
-->
<package xmlns="http://www.lovullo.com/rater"
  xmlns:c="http://www.lovullo.com/calc"
  xmlns:t="http://www.lovullo.com/rater/apply-template"
  core="true"
  desc="Mapping templates/functions">


  <template name="_map-set_" desc="Map a set of values">
    <param name="@name@" desc="Param name" />
    <param name="@index@" desc="Index" />
    <param name="@values@" desc="Criteria (map nodes)" />
    <param name="@label@" desc="Case statement label">
      <!-- default empty -->
      <text></text>
    </param>

    <param name="@default@" desc="Default value" />

    <c:cases label="@label@">
      <param-copy name="@values@">
        <param-meta name="map_param" value="@name@" />
        <param-meta name="map_index" value="@index@" />
      </param-copy>

      <!-- TODO: allow setting default via @default or t:default or something
           (or both) -->
      <if name="@default@">
        <c:otherwise>
          <c:const value="@default@" type="integer" desc="No mapping" />
        </c:otherwise>
      </if>
    </c:cases>
  </template>


  <template name="_map_" desc="Map criteria">
    <param name="@from@" desc="Value to map from" />
    <param name="@value@" desc="Constant to map to" />
    <param name="@to@" desc="Named value (use instead of @value@)" />

    <param name="@to-index@" desc="Named value index">
      <text></text>
    </param>

    <param name="@type@" desc="Constant value type">
      <text>float</text>
    </param>

    <param name="@desc@" desc="Map description">
      <text>Destination mapping</text>
    </param>

    <!-- set by parent map-set -->
    <param name="@name@" desc="Param name">
      <param-inherit meta="map_param" />
    </param>
    <param name="@index@" desc="Index">
      <param-inherit meta="map_index" />
    </param>


    <c:case>
      <!-- index provided -->
      <if name="@index@">
        <c:when name="@name@" index="@index@">
          <c:eq>
            <c:value-of name="@from@" />
          </c:eq>
        </c:when>
      </if>
      <!-- no index provided -->
      <unless name="@index@">
        <c:when name="@name@">
          <c:eq>
            <c:value-of name="@from@" />
          </c:eq>
        </c:when>
      </unless>

      <if name="@value@">
        <c:const value="@value@" desc="@desc@" />
      </if>
      <unless name="@value@">
        <c:value-of name="@to@" index="@to-index@" />
      </unless>
    </c:case>
  </template>


  <template name="_map-else_" desc="Non-matching map criteria">
    <param name="@value@" desc="Constant to map to" />
    <param name="@to@" desc="Named value (use instead of @value@)" />

    <param name="@to-index@" desc="Named value index">
      <text></text>
    </param>


    <c:otherwise>
      <if name="@value@">
        <c:const value="@value@" desc="@desc@" />
      </if>
      <unless name="@value@">
        <c:value-of name="@to@" index="@to-index@" />
      </unless>
    </c:otherwise>
  </template>
</package>

